<!DOCTYPE html>
<html>
<head>
    <title>경로 최적화</title>
    <script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=00286ba0bc3bb1e13bcad11a4c86f5ce&libraries=services"></script>
    <style>
        .container { display: flex; padding: 20px; gap: 20px; }
        .map-container { flex: 2; }
        .control-panel { flex: 1; }
        #map { width: 100%; height: 600px; }
        .input-group { margin-bottom: 15px; }
        .suggestions { background: white; border: 1px solid #ddd; }
        .suggestion-item { padding: 8px; cursor: pointer; }
        .suggestion-item:hover { background: #f5f5f5; }
    </style>
</head>
<body>
    <div class="container">
        <div class="map-container">
            <div id="map"></div>
        </div>
        <div class="control-panel">
            <h2>최적 경로 찾기</h2>
            <div class="input-group">
                <input type="text" id="address" placeholder="주소 입력" autocomplete="off">
                <div id="suggestions" class="suggestions"></div>
                <button onclick="setAsStart()">출발지로 설정</button>
                <button onclick="addToList()">경유지 추가</button>
            </div>
            <div id="addressList"></div>
            <button onclick="findOptimalRoute()">경로 최적화</button>
        </div>
    </div>

    <script>
        var map = new kakao.maps.Map(document.getElementById('map'), {
            center: new kakao.maps.LatLng(37.566826, 126.978656),
            level: 3
        });
        
        var places = new kakao.maps.services.Places();
        var geocoder = new kakao.maps.services.Geocoder();
        var markers = [];
        var addresses = [];
        var startPoint = null;
        
        // 주소 자동완성
        document.getElementById('address').addEventListener('input', function(e) {
            if (!e.target.value.trim()) return;
            
            places.keywordSearch(e.target.value, function(result, status) {
                if (status === kakao.maps.services.Status.OK) {
                    var suggestions = document.getElementById('suggestions');
                    suggestions.innerHTML = '';
                    result.slice(0, 5).forEach(function(place) {
                        var div = document.createElement('div');
                        div.className = 'suggestion-item';
                        div.textContent = place.place_name + ' (' + place.address_name + ')';
                        div.onclick = function() {
                            document.getElementById('address').value = place.place_name;
                            suggestions.innerHTML = '';
                            showOnMap(place);
                        };
                        suggestions.appendChild(div);
                    });
                }
            });
        });

        function showOnMap(place) {
            var coords = new kakao.maps.LatLng(place.y, place.x);
            var marker = new kakao.maps.Marker({
                map: map,
                position: coords
            });
            markers.push(marker);
            map.setCenter(coords);
        }

        function findOptimalRoute() {
            if (!startPoint || addresses.length === 0) {
                alert('출발지와 최소 1개의 경유지가 필요합니다');
                return;
            }

            // 거리 계산 및 최적 경로 찾기
            var allPoints = [startPoint, ...addresses];
            var distanceMatrix = [];
            var processed = 0;
            
            // 거리 행렬 생성
            for (let i = 0; i < allPoints.length; i++) {
                distanceMatrix[i] = [];
                for (let j = 0; j < allPoints.length; j++) {
                    if (i === j) {
                        distanceMatrix[i][j] = 0;
                        processed++;
                        continue;
                    }
                    
                    calculateDistance(allPoints[i], allPoints[j], function(distance) {
                        distanceMatrix[i][j] = distance;
                        processed++;
                        
                        if (processed === allPoints.length * allPoints.length) {
                            var route = nearestNeighbor(distanceMatrix);
                            displayRoute(route, allPoints);
                        }
                    });
                }
            }
        }

        function calculateDistance(point1, point2, callback) {
            geocoder.addressSearch(point1, function(result1, status1) {
                if (status1 === kakao.maps.services.Status.OK) {
                    geocoder.addressSearch(point2, function(result2, status2) {
                        if (status2 === kakao.maps.services.Status.OK) {
                            var coords1 = new kakao.maps.LatLng(result1[0].y, result1[0].x);
                            var coords2 = new kakao.maps.LatLng(result2[0].y, result2[0].x);
                            
                            // 직선 거리 계산
                            var distance = coords1.getLat() - coords2.getLat();
                            callback(Math.abs(distance));
                        }
                    });
                }
            });
        }

        function nearestNeighbor(distances) {
            var n = distances.length;
            var route = [0]; // 시작점
            var unvisited = Array.from({length: n-1}, (_, i) => i + 1);
            
            while (unvisited.length > 0) {
                var last = route[route.length - 1];
                var nearest = unvisited.reduce((min, curr) => 
                    distances[last][curr] < distances[last][min] ? curr : min
                , unvisited[0]);
                
                route.push(nearest);
                unvisited = unvisited.filter(x => x !== nearest);
            }
            
            return route;
        }

        function displayRoute(route, points) {
            var routeDisplay = document.createElement('div');
            routeDisplay.innerHTML = '<h3>최적 경로:</h3>';
            route.forEach((index, i) => {
                routeDisplay.innerHTML += `${i+1}. ${points[index]}<br>`;
            });
            document.getElementById('addressList').appendChild(routeDisplay);
        }

        // 나머지 기존 함수들...
        
    </script>
</body>
</html>
