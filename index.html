<!DOCTYPE html>
<html>
<head>
   <title>경로 최적화</title>
   <script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=00286ba0bc3bb1e13bcad11a4c86f5ce&libraries=services"></script>
   <style>
       .container { 
           display: flex; 
           padding: 20px; 
           gap: 20px; 
           max-width: 1200px;
           margin: 0 auto;
       }
       .map-container { flex: 2; }
       .control-panel { 
           flex: 1; 
           background: #fff;
           border-radius: 12px;
           padding: 20px;
           box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
       }
       #map { 
           width: 100%; 
           height: 600px;
           border-radius: 12px;
           box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
       }
       .input-group { margin-bottom: 15px; }
       .input-box {
           width: 100%;
           padding: 10px;
           border: 2px solid #e5e7eb;
           border-radius: 8px;
           margin-bottom: 10px;
       }
       .btn {
           padding: 10px 20px;
           border: none;
           border-radius: 8px;
           cursor: pointer;
           font-weight: bold;
           transition: all 0.2s;
           width: 100%;
           margin-bottom: 8px;
       }
       .btn-start {
           background: #4F46E5;
           color: white;
       }
       .btn-start:hover { background: #4338CA; }
       .btn-add {
           background: #10B981;
           color: white;
       }
       .btn-add:hover { background: #059669; }
       .btn-destination {
           background: #EF4444;
           color: white;
       }
       .btn-destination:hover { background: #DC2626; }
       .btn-optimize {
           background: #3B82F6;
           color: white;
           margin-top: 20px;
       }
       .btn-optimize:hover { background: #2563EB; }
       .suggestions {
           background: white;
           border: 1px solid #e5e7eb;
           border-radius: 8px;
           overflow: hidden;
           position: absolute;
           width: 100%;
           z-index: 1000;
       }
       .suggestion-item {
           padding: 10px;
           cursor: pointer;
           border-bottom: 1px solid #e5e7eb;
       }
       .suggestion-item:hover { background: #f3f4f6; }
       .address-item {
           padding: 10px;
           margin: 5px 0;
           background: #f3f4f6;
           border-radius: 8px;
           display: flex;
           justify-content: space-between;
           align-items: center;
       }
       .address-item.start { background: #e0e7ff; }
       .address-item.destination { background: #fee2e2; }
       .btn-delete {
           background: none;
           border: none;
           color: #EF4444;
           font-size: 20px;
           cursor: pointer;
           padding: 0 5px;
       }
       .btn-delete:hover { color: #DC2626; }
   </style>
</head>
<body>
   <div class="container">
       <div class="map-container">
           <div id="map"></div>
       </div>
       <div class="control-panel">
           <h2>최적 경로 찾기</h2>
           <div class="input-group">
               <input type="text" id="address" class="input-box" placeholder="주소 입력">
               <div id="suggestions" class="suggestions"></div>
               <button onclick="setAsStart()" class="btn btn-start">출발지로 설정</button>
               <button onclick="addToList()" class="btn btn-add">경유지 추가</button>
               <button onclick="setAsDestination()" class="btn btn-destination">도착지로 설정</button>
           </div>
           <div id="addressList"></div>
           <button onclick="findOptimalRoute()" class="btn btn-optimize">경로 최적화</button>
           <div id="routeResult"></div>
       </div>
   </div>

   <script>
       var map = new kakao.maps.Map(document.getElementById('map'), {
           center: new kakao.maps.LatLng(37.566826, 126.978656),
           level: 3
       });
       
       var places = new kakao.maps.services.Places();
       var geocoder = new kakao.maps.services.Geocoder();
       var markers = [];
       var addresses = [];
       var startPoint = null;
       var destination = null;
       
       document.getElementById('address').addEventListener('input', function(e) {
           if (!e.target.value.trim()) {
               document.getElementById('suggestions').innerHTML = '';
               return;
           }
           
           places.keywordSearch(e.target.value, function(result, status) {
               if (status === kakao.maps.services.Status.OK) {
                   var suggestions = document.getElementById('suggestions');
                   suggestions.innerHTML = '';
                   result.slice(0, 5).forEach(function(place) {
                       var div = document.createElement('div');
                       div.className = 'suggestion-item';
                       div.textContent = place.place_name + ' (' + place.address_name + ')';
                       div.onclick = function() {
                           document.getElementById('address').value = place.place_name;
                           suggestions.innerHTML = '';
                           showOnMap(place);
                       };
                       suggestions.appendChild(div);
                   });
               }
           });
       });

       function showOnMap(place) {
           markers.forEach(marker => marker.setMap(null));
           markers = [];
           
           var coords = new kakao.maps.LatLng(place.y, place.x);
           var marker = new kakao.maps.Marker({
               map: map,
               position: coords
           });
           markers.push(marker);
           map.setCenter(coords);
       }

       function setAsStart() {
           const addressInput = document.getElementById('address').value;
           if (addressInput) {
               startPoint = addressInput;
               updateDisplay();
               document.getElementById('address').value = '';
           }
       }

       function setAsDestination() {
           const addressInput = document.getElementById('address').value;
           if (addressInput) {
               destination = addressInput;
               updateDisplay();
               document.getElementById('address').value = '';
           }
       }

       function addToList() {
           const addressInput = document.getElementById('address').value;
           if (addressInput && !addresses.includes(addressInput)) {
               addresses.push(addressInput);
               updateDisplay();
               document.getElementById('address').value = '';
           }
       }

       function removeStart() {
           startPoint = null;
           updateDisplay();
       }

       function removeAddress(index) {
           addresses.splice(index, 1);
           updateDisplay();
       }

       function removeDestination() {
           destination = null;
           updateDisplay();
       }

       function updateDisplay() {
           const list = document.getElementById('addressList');
           list.innerHTML = '';
           
           if (startPoint) {
               list.innerHTML += `
                   <div class="address-item start">
                       <span>출발: ${startPoint}</span>
                       <button onclick="removeStart()" class="btn-delete">×</button>
                   </div>`;
           }
           
           addresses.forEach((addr, i) => {
               list.innerHTML += `
                   <div class="address-item">
                       <span>경유${i+1}: ${addr}</span>
                       <button onclick="removeAddress(${i})" class="btn-delete">×</button>
                   </div>`;
           });

           if (destination) {
               list.innerHTML += `
                   <div class="address-item destination">
                       <span>도착: ${destination}</span>
                       <button onclick="removeDestination()" class="btn-delete">×</button>
                   </div>`;
           }
       }

       function findOptimalRoute() {
           if (!startPoint || (!addresses.length && !destination)) {
               alert('출발지와 최소 1개의 경유지 또는 도착지가 필요합니다');
               return;
           }

           // 기존 마커와 경로 삭제
           markers.forEach(marker => marker.setMap(null));
           markers = [];

           var allPoints = [startPoint, ...addresses];
           if (destination) allPoints.push(destination);

           var linePath = [];
           var bounds = new kakao.maps.LatLngBounds();
           
           // 각 지점의 좌표 얻기
           allPoints.forEach((point, i) => {
               geocoder.addressSearch(point, function(result, status) {
                   if (status === kakao.maps.services.Status.OK) {
                       var coords = new kakao.maps.LatLng(result[0].y, result[0].x);
                       linePath.push(coords);
                       bounds.extend(coords);

                       // 마커 생성
                       var marker = new kakao.maps.Marker({
                           map: map,
                           position: coords
                       });
                       markers.push(marker);

                       // 모든 포인트가 준비되면 경로 표시
                       if (linePath.length === allPoints.length) {
                           // 경로 그리기
                           var polyline = new kakao.maps.Polyline({
                               path: linePath,
                               strokeWeight: 5,
                               strokeColor: '#FF0000',
                               strokeOpacity: 0.7
                           });
                           
                           polyline.setMap(map);
                           map.setBounds(bounds);

                           // 경로 결과 표시
                           displayRouteResult(allPoints);
                       }
                   }
               });
           });
       }

       function displayRouteResult(points) {
           const resultDiv = document.getElementById('routeResult');
           resultDiv.innerHTML = '<h3>최적 경로:</h3>';
           points.forEach((point, i) => {
               const className = i === 0 ? 'start' : 
                               i === points.length - 1 && destination ? 'destination' : '';
               resultDiv.innerHTML += `
                   <div class="address-item ${className}">
                       ${i + 1}. ${point}
                   </div>`;
           });
       }
   </script>
</body>
</html>
